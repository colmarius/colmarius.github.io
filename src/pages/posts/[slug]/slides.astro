---
import { type CollectionEntry, getCollection, render } from 'astro:content';
import BackNav from '@components/BackNav.astro';
import '../../../styles/global.css';

export async function getStaticPaths() {
  const posts = await getCollection('posts');

  const filteredPosts = import.meta.env.PROD
    ? posts.filter((post) => !post.data.draft)
    : posts;

  return filteredPosts.map((post) => ({
    params: { slug: post.id },
    props: post,
  }));
}

type Props = CollectionEntry<'posts'>;

const post = Astro.props;
const { Content } = await render(post);
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{post.data.title} - Slides</title>
    <style>
      :global(.slide) {
        display: none;
      }

      :global(.slide.active) {
        display: block;
      }

      #source {
        display: none;
      }
    </style>
  </head>
  <body class="bg-white text-slate-900 overflow-hidden">
    <div class="fixed top-0 left-0 right-0 h-14 bg-white border-b border-slate-200 flex items-center justify-between px-4 sm:px-8 z-50">
      <BackNav href={`/posts/${post.id}`} label="Back to Post" />
      <div class="text-sm font-semibold text-slate-900 flex-1 text-center truncate px-4">{post.data.title}</div>
      <div class="text-sm text-slate-600 min-w-16 text-right">
        <span id="current">1</span> / <span id="total">1</span>
      </div>
    </div>

    <div id="slides-container" class="fixed top-14 left-0 right-0 bottom-0 overflow-y-auto p-4 sm:p-8"></div>

    <div id="source">
      <Content />
    </div>

    <div class="fixed bottom-4 sm:bottom-8 right-4 sm:right-8 flex gap-2 z-50">
      <button
        class="w-10 h-10 sm:w-12 sm:h-12 bg-white border border-slate-200 rounded-lg text-slate-600 cursor-pointer flex items-center justify-center text-xl transition-all hover:bg-slate-50 hover:text-slate-900 hover:border-slate-300 disabled:opacity-30 disabled:cursor-not-allowed"
        id="prev-btn"
        aria-label="Previous slide"
      >
        ←
      </button>
      <button
        class="w-10 h-10 sm:w-12 sm:h-12 bg-white border border-slate-200 rounded-lg text-slate-600 cursor-pointer flex items-center justify-center text-xl transition-all hover:bg-slate-50 hover:text-slate-900 hover:border-slate-300 disabled:opacity-30 disabled:cursor-not-allowed"
        id="next-btn"
        aria-label="Next slide"
      >
        →
      </button>
    </div>

    <script>
      import { renderMermaid } from '@scripts/mermaid';

      // Render Mermaid and signal ready
      async function initMermaid() {
        await renderMermaid();
        window.dispatchEvent(new Event('mermaid-ready'));
      }

      // Run immediately if DOM ready, otherwise wait
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initMermaid);
      } else {
        initMermaid();
      }
    </script>

    <script is:inline>
      // Split content by H2 headers
      function splitIntoSlides() {
        const source = document.getElementById('source');
        const container = document.getElementById('slides-container');
        const nodes = Array.from(source.children);

        let slides = [];
        let currentSlide = [];

        for (const node of nodes) {
          if (node.tagName === 'H2') {
            if (currentSlide.length > 0) {
              slides.push(currentSlide);
            }
            currentSlide = [node.cloneNode(true)];
          } else {
            currentSlide.push(node.cloneNode(true));
          }
        }

        if (currentSlide.length > 0) {
          slides.push(currentSlide);
        }

        // If no H2s found, treat entire content as one slide
        if (slides.length === 0) {
          slides.push(nodes.map(n => n.cloneNode(true)));
        }

        // Create slide elements
        slides.forEach((slideNodes, index) => {
          const slideDiv = document.createElement('div');
          slideDiv.className = 'slide prose-slide mx-auto max-w-3xl bg-white border border-slate-200 rounded-lg p-8 sm:p-12 shadow-sm';
          slideDiv.dataset.index = index;
          slideNodes.forEach(node => slideDiv.appendChild(node));

          // Remove mermaid-loading class from cloned mermaid elements
          slideDiv.querySelectorAll('.mermaid-loading').forEach(el => {
            el.classList.remove('mermaid-loading');
          });

          container.appendChild(slideDiv);
        });

        return slides.length;
      }

      // Navigation state
      let currentIndex = 0;
      let totalSlides = 0;

      function updateSlide() {
        const slides = document.querySelectorAll('.slide');
        slides.forEach((slide, index) => {
          slide.classList.toggle('active', index === currentIndex);
        });

        document.getElementById('current').textContent = currentIndex + 1;
        document.getElementById('prev-btn').disabled = currentIndex === 0;
        document.getElementById('next-btn').disabled = currentIndex === totalSlides - 1;

        window.location.hash = currentIndex + 1;
      }

      function nextSlide() {
        if (currentIndex < totalSlides - 1) {
          currentIndex++;
          updateSlide();
        }
      }

      function prevSlide() {
        if (currentIndex > 0) {
          currentIndex--;
          updateSlide();
        }
      }

      // Initialize - wait for Mermaid rendering then split
      function initialize() {
        totalSlides = splitIntoSlides();
        document.getElementById('total').textContent = totalSlides;

        // Check hash for initial slide
        const hash = window.location.hash.slice(1);
        if (hash && !isNaN(hash)) {
          const slideNum = parseInt(hash, 10) - 1;
          if (slideNum >= 0 && slideNum < totalSlides) {
            currentIndex = slideNum;
          }
        }

        updateSlide();
      }

      // Wait for Mermaid to finish rendering before splitting
      window.addEventListener('mermaid-ready', initialize);

      // Event listeners
      document.getElementById('prev-btn').addEventListener('click', prevSlide);
      document.getElementById('next-btn').addEventListener('click', nextSlide);

      document.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
          prevSlide();
        } else if (e.key === 'ArrowRight' || e.key === 'ArrowDown' || e.key === ' ') {
          e.preventDefault();
          nextSlide();
        }
      });

    </script>

    <style is:global>
      /* Mermaid diagram styles */
      .mermaid {
        display: flex;
        justify-content: center;
        margin: 2rem 0;
      }
      .mermaid svg {
        display: block;
        max-width: 100%;
        height: auto;
      }
      .mermaid-loading {
        opacity: 0;
        min-height: 200px;
      }
    </style>
  </body>
</html>
